{% extends 'base.html' %}

{% block scripts %}

{{ super() }}

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
  // Initialize data for skill charts
  const playerCharts = {};

  {% for ht_id in allplayerids %}
    var rawDatasets{{ ht_id }} = [
      {
        label: "Keeper",
        backgroundColor: "rgba(59, 130, 246, 0.1)",
        borderColor: "rgba(59, 130, 246, 1)",
        data: [
          {% for (dat, skills) in allplayers[ht_id] %}
          {{ skills[0] }},
          {% endfor %}
        ],
        tension: 0.3,
        fill: true
      },
      {
        label: "Defender",
        backgroundColor: "rgba(239, 68, 68, 0.1)",
        borderColor: "rgba(239, 68, 68, 1)",
        data: [
          {% for (dat, skills) in allplayers[ht_id] %}
          {{ skills[1] }},
          {% endfor %}
        ],
        tension: 0.3,
        fill: true
      },
      {
        label: "Playmaker",
        backgroundColor: "rgba(139, 92, 246, 0.1)",
        borderColor: "rgba(139, 92, 246, 1)",
        data: [
          {% for (dat, skills) in allplayers[ht_id] %}
          {{ skills[2] }},
          {% endfor %}
        ],
        tension: 0.3,
        fill: true
      },
      {
        label: "Winger",
        backgroundColor: "rgba(236, 72, 153, 0.1)",
        borderColor: "rgba(236, 72, 153, 1)",
        data: [
          {% for (dat, skills) in allplayers[ht_id] %}
          {{ skills[3] }},
          {% endfor %}
        ],
        tension: 0.3,
        fill: true
      },
      {
        label: "Passing",
        backgroundColor: "rgba(20, 184, 166, 0.1)",
        borderColor: "rgba(20, 184, 166, 1)",
        data: [
          {% for (dat, skills) in allplayers[ht_id] %}
          {{ skills[4] }},
          {% endfor %}
        ],
        tension: 0.3,
        fill: true
      },
      {
        label: "Scoring",
        backgroundColor: "rgba(245, 158, 11, 0.1)",
        borderColor: "rgba(245, 158, 11, 1)",
        data: [
          {% for (dat, skills) in allplayers[ht_id] %}
          {{ skills[5] }},
          {% endfor %}
        ],
        tension: 0.3,
        fill: true
      },
      {
        label: "Set Pieces",
        backgroundColor: "rgba(99, 102, 241, 0.1)",
        borderColor: "rgba(99, 102, 241, 1)",
        data: [
          {% for (dat, skills) in allplayers[ht_id] %}
          {{ skills[6] }},
          {% endfor %}
        ],
        tension: 0.3,
        fill: true
      }
    ];

    // Filter out datasets with no changes (all values the same)
    var filteredDatasets{{ ht_id }} = rawDatasets{{ ht_id }}.filter(function(dataset) {
      var firstValue = dataset.data[0];
      return dataset.data.some(function(value) {
        return value !== firstValue;
      });
    });

    var data{{ ht_id }} = {
      labels: [
        {% for (dat, skills) in allplayers[ht_id] %}
        "{{ dat.strftime('%Y-%m-%d') }}",
        {% endfor %}
      ],
      datasets: filteredDatasets{{ ht_id }}
    };

    var ctx{{ ht_id }} = document.getElementById('playerChart{{ ht_id }}');
    if (ctx{{ ht_id }}) {
      playerCharts[{{ ht_id }}] = new Chart(ctx{{ ht_id }}, {
        type: 'line',
        data: data{{ ht_id }},
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              position: 'top',
              labels: {
                boxWidth: 12,
                font: { size: 11 }
              }
            },
            title: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              min: 0,
              max: 20,
              grid: {
                drawBorder: false
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          }
        }
      });
    }
  {% endfor %}

  // Search and filter functionality
  function filterPlayers(query) {
    const items = document.querySelectorAll('[data-player-item]');
    items.forEach(item => {
      const text = item.textContent.toLowerCase();
      item.style.display = text.includes(query.toLowerCase()) ? '' : 'none';
    });
  }

  // Player selection
  function selectPlayer(ht_id) {
    document.querySelectorAll('[data-player-card]').forEach(card => {
      card.style.display = 'none';
    });
    document.querySelectorAll('[data-player-item]').forEach(item => {
      item.classList.remove('active', 'bg-blue-50', 'border-blue-300');
    });

    const selectedCard = document.getElementById('playerCard' + ht_id);
    if (selectedCard) selectedCard.style.display = 'block';

    const selectedItem = document.getElementById('playerItem' + ht_id);
    if (selectedItem) {
      selectedItem.classList.add('active', 'bg-blue-50', 'border-blue-300');
    }
  }

  // Initialize first player
  document.addEventListener('DOMContentLoaded', function() {
    {% if allplayerids %}
      selectPlayer({{ allplayerids[0] }});
    {% endif %}
  });
</script>

{% endblock %}

{% block content %}

<div class="container">
  <div class="row">
    <div class="col-sm">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/">{{ teamname }}</a></li>
          <li class="breadcrumb-item active" aria-current="page">{{ title }}</li>
        </ol>
      </nav>
    </div>
  </div>

  {% if error %}
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
    {{ error }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  {% endif %}

  <!-- Main Content Grid -->
  <div class="row g-4">
    <!-- Player List Sidebar -->
    <div class="col-12 col-lg-3">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">Squad</h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <input
              type="text"
              class="form-control form-control-sm"
              placeholder="Search players..."
              id="playerSearch"
              onkeyup="filterPlayers(this.value)"
              aria-label="Search players"
            >
          </div>
          <div class="player-list" style="max-height: 500px; overflow-y: auto;">
            {% if allplayerids %}
              {% for ht_id in allplayerids %}
              <button
                type="button"
                class="w-100 btn btn-sm btn-outline-primary text-start mb-2 p-2 d-flex justify-content-between align-items-center"
                id="playerItem{{ ht_id }}"
                data-player-item
                onclick="selectPlayer({{ ht_id }})"
                style="border-radius: 0.375rem;"
              >
                <span class="small fw-semibold text-truncate">{{ playernames[ht_id] }}</span>
                {% if increases.get(ht_id) %}
                  <span class="badge {% if increases[ht_id] > 0 %}bg-success{% else %}bg-danger{% endif %} text-white ms-2 flex-shrink-0">
                    {% if increases[ht_id] > 0 %}+{% endif %}{{ increases[ht_id] }}
                  </span>
                {% endif %}
              </button>
              {% endfor %}
            {% else %}
            <p class="text-muted small">No players recorded</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Player Details -->
    <div class="col-12 col-lg-9">
      <div class="row g-4">
        {% for ht_id in allplayerids %}
        <div class="col-12" id="playerCard{{ ht_id }}" data-player-card style="display: none;">
          <!-- Skill Summary Cards -->
          <div class="row g-2 mb-4" style="justify-content: center;">
            {% if allplayers[ht_id] %}
              {% set latest = allplayers[ht_id][-1] %}
              {% set earliest = allplayers[ht_id][0] %}
              <div style="flex: 0 0 calc(100% / 8);">
                <div class="card text-center">
                  <div class="card-body p-3">
                    <small class="text-muted d-block">Keeper</small>
                    <h4 class="mb-1">{{ latest[1][0] }}</h4>
                    <small class="{% if latest[1][0] > earliest[1][0] %}text-success{% elif latest[1][0] < earliest[1][0] %}text-danger{% else %}text-muted{% endif %}">
                      {% if latest[1][0] > earliest[1][0] %}+{% endif %}{{ latest[1][0] - earliest[1][0] }}
                    </small>
                  </div>
                </div>
              </div>
              <div style="flex: 0 0 calc(100% / 8);">
                <div class="card text-center">
                  <div class="card-body p-3">
                    <small class="text-muted d-block">Defender</small>
                    <h4 class="mb-1">{{ latest[1][1] }}</h4>
                    <small class="{% if latest[1][1] > earliest[1][1] %}text-success{% elif latest[1][1] < earliest[1][1] %}text-danger{% else %}text-muted{% endif %}">
                      {% if latest[1][1] > earliest[1][1] %}+{% endif %}{{ latest[1][1] - earliest[1][1] }}
                    </small>
                  </div>
                </div>
              </div>
              <div style="flex: 0 0 calc(100% / 8);">
                <div class="card text-center">
                  <div class="card-body p-3">
                    <small class="text-muted d-block">Playmaker</small>
                    <h4 class="mb-1">{{ latest[1][2] }}</h4>
                    <small class="{% if latest[1][2] > earliest[1][2] %}text-success{% elif latest[1][2] < earliest[1][2] %}text-danger{% else %}text-muted{% endif %}">
                      {% if latest[1][2] > earliest[1][2] %}+{% endif %}{{ latest[1][2] - earliest[1][2] }}
                    </small>
                  </div>
                </div>
              </div>
              <div style="flex: 0 0 calc(100% / 8);">
                <div class="card text-center">
                  <div class="card-body p-3">
                    <small class="text-muted d-block">Winger</small>
                    <h4 class="mb-1">{{ latest[1][3] }}</h4>
                    <small class="{% if latest[1][3] > earliest[1][3] %}text-success{% elif latest[1][3] < earliest[1][3] %}text-danger{% else %}text-muted{% endif %}">
                      {% if latest[1][3] > earliest[1][3] %}+{% endif %}{{ latest[1][3] - earliest[1][3] }}
                    </small>
                  </div>
                </div>
              </div>
              <div style="flex: 0 0 calc(100% / 8);">
                <div class="card text-center">
                  <div class="card-body p-3">
                    <small class="text-muted d-block">Passing</small>
                    <h4 class="mb-1">{{ latest[1][4] }}</h4>
                    <small class="{% if latest[1][4] > earliest[1][4] %}text-success{% elif latest[1][4] < earliest[1][4] %}text-danger{% else %}text-muted{% endif %}">
                      {% if latest[1][4] > earliest[1][4] %}+{% endif %}{{ latest[1][4] - earliest[1][4] }}
                    </small>
                  </div>
                </div>
              </div>
              <div style="flex: 0 0 calc(100% / 8);">
                <div class="card text-center">
                  <div class="card-body p-3">
                    <small class="text-muted d-block">Scoring</small>
                    <h4 class="mb-1">{{ latest[1][5] }}</h4>
                    <small class="{% if latest[1][5] > earliest[1][5] %}text-success{% elif latest[1][5] < earliest[1][5] %}text-danger{% else %}text-muted{% endif %}">
                      {% if latest[1][5] > earliest[1][5] %}+{% endif %}{{ latest[1][5] - earliest[1][5] }}
                    </small>
                  </div>
                </div>
              </div>
              <div style="flex: 0 0 calc(100% / 8);">
                <div class="card text-center">
                  <div class="card-body p-3">
                    <small class="text-muted d-block">Set Pieces</small>
                    <h4 class="mb-1">{{ latest[1][6] }}</h4>
                    <small class="{% if latest[1][6] > earliest[1][6] %}text-success{% elif latest[1][6] < earliest[1][6] %}text-danger{% else %}text-muted{% endif %}">
                      {% if latest[1][6] > earliest[1][6] %}+{% endif %}{{ latest[1][6] - earliest[1][6] }}
                    </small>
                  </div>
                </div>
              </div>
            {% endif %}
          </div>

          <!-- Skill Progression Chart -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="card-title mb-0">Skill Progression</h5>
            </div>
            <div class="card-body">
              <div style="position: relative; height: 300px;">
                <canvas id="playerChart{{ ht_id }}" role="img" aria-label="Skill progression chart"></canvas>
              </div>
            </div>
          </div>

          <!-- Training History Table -->
          {% if allplayers[ht_id] %}
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">Training History</h5>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table-custom table-hover mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>Date</th>
                      <th class="text-end">Keeper</th>
                      <th class="text-end">Defender</th>
                      <th class="text-end">Playmaker</th>
                      <th class="text-end">Winger</th>
                      <th class="text-end">Passing</th>
                      <th class="text-end">Scoring</th>
                      <th class="text-end">Set Pieces</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for (date, skills, changes) in skill_changes[ht_id] %}
                    <tr>
                      <td><small>{{ date.strftime('%Y-%m-%d') }}</small></td>
                      {% for i in range(7) %}
                        {% set val = skills[i] %}
                        {% set change = changes[i] %}
                        <td class="text-end">
                          <small>
                            {% if change > 0 %}
                              <span style="color: #22c55e; font-weight: bold;">↑</span>
                            {% elif change < 0 %}
                              <span style="color: #ef4444; font-weight: bold;">↓</span>
                            {% else %}
                              <span style="color: #999;"> </span>
                            {% endif %}
                            {{ val }}
                          </small>
                        </td>
                      {% endfor %}
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

{% endblock %}
