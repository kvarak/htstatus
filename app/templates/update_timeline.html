{% extends 'base.html' %}

{% block scripts %}
{{ super() }}
<style>
  .update-content {
    padding: 0.5rem 0;
  }

  .page-title-box {
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid hsl(120, 20%, 85%);
    border-radius: 0.25rem;
    padding: 0.5rem;
    margin-bottom: 0.5rem;
  }

  .page-title-box .breadcrumb-item {
    color: hsl(120, 45%, 25%);
    font-weight: 600;
    font-size: 1rem;
  }

  .status-message {
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid hsl(120, 20%, 85%);
    border-radius: 0.25rem;
  }

  .status-success {
    color: hsl(120, 70%, 35%);
  }

  .status-error {
    color: hsl(0, 84%, 60%);
  }

  .status-warning {
    color: hsl(45, 90%, 55%);
  }

  /* Timeline Styles - 4 Column Layout */
  .timeline-container {
    background: white;
    border: 1px solid #ddd;
    border-radius: 0.25rem;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
  }

  .timeline-title {
    font-size: 1rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 0.75rem;
    text-align: center;
  }

  .timeline {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
    margin-top: 0.5rem;
  }

  .week-container {
    background: white;
    border: 1px solid #ddd;
    border-radius: 0.25rem;
    overflow: hidden;
    height: fit-content;
  }

  .week-container.current-week {
    border-color: #28a745;
    border-width: 2px;
  }

  .week-header {
    background: #f8f9fa;
    border-bottom: 1px solid #ddd;
    padding: 0.5rem;
    text-align: center;
  }

  .week-container.current-week .week-header {
    background: #28a745;
    color: white;
  }

  .week-title {
    font-weight: 600;
    font-size: 0.85rem;
    margin-bottom: 0.2rem;
  }

  .week-subtitle {
    font-size: 0.7rem;
    color: #666;
  }

  .week-container.current-week .week-subtitle {
    color: rgba(255, 255, 255, 0.8);
  }

  .current-week-badge {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    padding: 0.15rem 0.4rem;
    border-radius: 0.2rem;
    font-size: 0.65rem;
    margin-top: 0.2rem;
    display: inline-block;
  }

  .week-content {
    padding: 0.75rem;
  }

  .week-changes {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .day-group {
    padding-left: 0.5rem;
    border-left: 2px solid #28a745;
    margin-bottom: 0.5rem;
  }

  .day-header {
    font-size: 0.75rem;
    color: #28a745;
    font-weight: 600;
    margin-bottom: 0.3rem;
    padding: 0.2rem 0;
  }

  .player-entry {
    padding: 0.4rem;
    background: #f8f9fa;
    border-radius: 0.2rem;
    margin-bottom: 0.35rem;
  }

  .player-name {
    font-weight: 600;
    color: #333;
    font-size: 0.8rem;
    margin-bottom: 0.2rem;
  }

  .skill-item {
    font-size: 0.75rem;
    padding: 0.15rem 0;
  }

  .skill-up {
    color: #28a745;
    font-weight: 500;
  }

  .skill-down {
    color: #dc3545;
    font-weight: 500;
  }

  .money-change {
    color: #007bff;
    font-weight: 500;
  }

  .age-change {
    color: #6f42c1;
    font-weight: 500;
  }

  .other-change {
    color: #6c757d;
    font-weight: 500;
  }

  .change-item {
    font-size: 0.75rem;
    padding: 0.15rem 0;
  }

  .no-changes {
    color: #666;
    font-style: italic;
    font-size: 0.8rem;
    padding: 0.75rem;
    text-align: center;
    background: #f8f9fa;
  }

  .updated-teams-box {
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid hsl(120, 20%, 85%);
    border-radius: 0.4rem;
    padding: 0.75rem;
    margin-bottom: 0.75rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .team-link {
    color: hsl(120, 45%, 25%);
    text-decoration: none;
    font-weight: 600;
    font-size: 0.9rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    transition: all 0.2s ease;
  }

  .team-link:hover {
    background: hsl(120, 45%, 95%);
    text-decoration: none;
    color: hsl(120, 55%, 20%);
  }

  .divider {
    border: none;
    border-top: 2px solid hsl(120, 20%, 85%);
    margin: 1rem 0;
  }

  /* Responsive Design */
  @media (max-width: 1200px) {
    .timeline {
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
    }
  }

  @media (max-width: 768px) {
    .timeline {
      grid-template-columns: 1fr;
      gap: 0.75rem;
    }

    .timeline-container {
      padding: 0.75rem;
    }

    .week-header {
      padding: 0.5rem;
    }

    .week-content {
      padding: 0.5rem;
    }

    .player-entry {
      padding: 0.35rem;
    }

    .day-group {
      padding-left: 0.5rem;
      border-left-width: 2px;
    }
  }

  @media (max-width: 480px) {
    .timeline-title {
      font-size: 1rem;
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
    }

    .week-title {
      font-size: 0.8rem;
    }

    .week-subtitle {
      font-size: 0.65rem;
    }

    .player-name {
      font-size: 0.8rem;
    }

    .skill-item {
      font-size: 0.75rem;
    }
  }
</style>
{% endblock %}

{% block content %}

<div class="update-content">
  <div class="container">
    <!-- Breadcrumb/Title -->
    <div class="page-title-box">
      <nav aria-label="breadcrumb" class="mb-0">
        <ol class="breadcrumb" style="background: transparent; padding: 0; margin: 0;">
          <li class="breadcrumb-item active">Update Complete - Player Change Timeline</li>
        </ol>
      </nav>
    </div>

    <!-- Status Messages -->
    {% if request.args.get('success') %}
      <div class="status-message status-success">
        âœ“ Data downloaded successfully
      </div>
    {% endif %}

    <!-- Players Left -->
    {% if left_players %}
      <div class="status-message status-warning">
        âš  Players left team:
        {% for lplayer in left_players %}
          {{ lplayer[1] }}{% if not loop.last %}, {% endif %}
        {% endfor %}
      </div>
    {% endif %}

    <!-- New Players -->
    {% if new_players %}
      <div class="status-message status-success">
        âœ“ New players:
        {% for nplayer in new_players %}
          {{ nplayer[1] }}{% if not loop.last %}, {% endif %}
        {% endfor %}
      </div>
    {% endif %}

    <!-- Updated Teams Links -->
    {% if updated %}
      <div class="updated-teams-box">
        {% for teamid, team_data in updated.items() %}
          <p style="margin: 0.5rem 0; font-size: 0.9rem;">
            <span style="color: hsl(120, 45%, 25%); font-weight: 600;">{{ team_data[0] }}:</span>
            <a href="{{ team_data[1] }}" class="team-link">{{ team_data[2] }}</a>
          </p>
        {% endfor %}
      </div>

      <hr class="divider">
    {% endif %}

    <!-- 4-Week Player Change Timeline -->
    {% if timeline_changes %}
      <div class="timeline-container">
        <div class="timeline-title">Player Skill Changes - 4 Week Timeline</div>

        <div class="timeline">
          {% for week_key in ['week_1', 'week_2', 'week_3', 'week_4'] %}
            {% set week = timeline_changes[week_key] %}
            <div class="week-container{% if week.is_current %} current-week{% endif %}">
              <div class="week-header">
                <div class="week-title">
                  {% if week.is_current %}
                    This Week
                  {% else %}
                    {{ week_key.replace('week_', '') }} Week{{ 's' if week_key != 'week_2' else '' }} Ago
                  {% endif %}
                </div>
                <div class="week-subtitle">
                  {% if week.is_current %}
                    Today through 6 days ago
                  {% else %}
                    {{ week.days_ago_start }}-{{ week.days_ago_end }} days ago
                  {% endif %}
                </div>
                {% if week.is_current %}
                  <span class="current-week-badge">Current</span>
                {% endif %}
              </div>

              <div class="week-content">
                {% if week.changes %}
                  <div class="week-changes">
                    {# Group changes by player name #}
                    {% set player_changes = {} %}
                    {% for change in week.changes %}
                      {% set player_name = change[0] %}
                      {% if player_name not in player_changes %}
                        {% set _ = player_changes.update({player_name: []}) %}
                      {% endif %}
                      {% set _ = player_changes[player_name].append(change) %}
                    {% endfor %}

                    {% for player_name, changes in player_changes.items() %}
                      <div class="player-entry">
                        <div class="player-name">{{ player_name }}</div>
                        {% for change in changes %}
                          <div class="change-item">
                            {% if change[4] == 'skill' %}
                              {% if change[3] > change[2] %}
                                <span class="skill-up">ðŸ“ˆ {{ change[1] }}: {{ change[2] }} â†’ {{ change[3] }}</span>
                              {% else %}
                                <span class="skill-down">ðŸ“‰ {{ change[1] }}: {{ change[2] }} â†’ {{ change[3] }}</span>
                              {% endif %}
                            {% elif change[4] == 'money' %}
                              <span class="money-change">ðŸ’° {{ change[1] }}: {{ "{:,}".format(change[2]) }} â†’ {{ "{:,}".format(change[3]) }}</span>
                            {% elif change[4] == 'age' %}
                              <span class="age-change">ðŸŽ‚ {{ change[1] }}: {{ change[2] }} â†’ {{ change[3] }} years</span>
                            {% else %}
                              <span class="other-change">ðŸ”„ {{ change[1] }}: {{ change[2] }} â†’ {{ change[3] }}</span>
                            {% endif %}
                          </div>
                        {% endfor %}
                      </div>
                    {% endfor %}
                  </div>
                {% else %}
                  <div class="no-changes">No changes recorded for this period</div>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% else %}
      <div class="no-changes">No player change data available</div>
    {% endif %}
  </div>
</div>

{% endblock %}