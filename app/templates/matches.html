{% extends 'base.html' %}
{% block content %}
  <!-- Work in Progress Sticker -->
  <div class="wip-sticker">
    <span>üöß Work in Progress</span>
  </div>
  <div class="container">
    <div class="row">
      <div class="col-12">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb d-flex justify-content-between align-items-center">
            <div class="d-flex">
              <li class="breadcrumb-item">
                <a href="#">{{ teamname }}</a>
              </li>
              <li class="breadcrumb-item active" aria-current="page">{{ title }}</li>
            </div>
            {% if not(error) %}
              <form method="POST" action="/matches" class="mb-0">
                <input type="hidden" id="id" name="id" value="{{ teamid }}">
                <button type="submit"
                        name="updatebutton"
                        value="archive"
                        class="btn btn-sm btn-primary-custom"
                        aria-label="Download Archive"
                        data-toggle="tooltip"
                        data-placement="top"
                        title="2 seasons back"
                        onclick="loading();">Download Archive</button>
              </form>
            {% endif %}
          </ol>
        </nav>
      </div>
    </div>
    {% if error %}<div class="alert alert-danger" role="alert">{{ error }}</div>{% endif %}
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ 'success' if category == 'info' else category }}"
               role="alert">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}
    <!-- Main Content Grid -->
    <div class="row g-4">
      <!-- Matches List Sidebar -->
      <div class="col-12 col-lg-4">
        {# Upcoming Matches #}
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0 card-title">Upcoming Matches</h5>
          </div>
          <div class="card-body p-2">
            <div class="list-group list-group-flush">
              {% for m in upcoming_matches %}
                <div class="list-group-item list-group-item-action p-2 small border-0 mb-1 rounded"
                     style="cursor: pointer;
                            border-left: 4px solid {% if m.matchtype == 1 %} #007bff;
                            {% elif m.matchtype == 3 %} #28a745;
                            {% elif m.matchtype == 4 or m.matchtype == 5 or m.matchtype == 8 or m.matchtype == 9 %} #ffc107;
                            {% else %} #6c757d;
                            {% endif %}"
                     data-match="{{ m.ht_id }}">
                  <div class="d-flex justify-content-between align-items-center mb-1">
                    <small class="text-muted">{{ m.datetime.strftime("%m-%d %H:%M") }}</small>
                    <span class="badge badge-secondary badge-sm">
                      {% if m.home_team_name == teamname %}
                        {{ m.away_team_name }}
                      {% else %}
                        {{ m.home_team_name }}
                      {% endif %}
                    </span>
                  </div>
                  <div class="fw-bold small">Next Match</div>
                </div>
              {% endfor %}
              {% if not has_upcoming %}
                <div class="text-center text-muted small py-3">
                  <p>No upcoming matches scheduled</p>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
        {# Match History #}
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0 card-title">Recent Matches</h5>
            <div class="btn-group btn-group-sm"
                 role="group"
                 aria-label="Filter matches">
              <button type="button"
                      class="btn btn-outline-secondary filter-btn active"
                      data-filter="all"
                      data-target="history">All</button>
              <button type="button"
                      class="btn btn-outline-secondary filter-btn"
                      data-filter="1"
                      data-target="history">League</button>
              <button type="button"
                      class="btn btn-outline-secondary filter-btn"
                      data-filter="3"
                      data-target="history">Cup</button>
              <button type="button"
                      class="btn btn-outline-secondary filter-btn"
                      data-filter="4"
                      data-target="history">Friendly</button>
            </div>
          </div>
          <div class="card-body p-2" style="max-height: 600px; overflow-y: auto;">
            <div class="list-group list-group-flush">
              {% for m in history_matches %}
                {% if m.home_goals is not none %}
                  <div class="list-group-item list-group-item-action p-2 small border-0 mb-1 rounded"
                       style="cursor: pointer;
                              border-left: 4px solid {% if m.matchtype == 1 %} #007bff;
                              {% elif m.matchtype == 3 %} #28a745;
                              {% elif m.matchtype == 4 or m.matchtype == 5 or m.matchtype == 8 or m.matchtype == 9 %} #ffc107;
                              {% else %} #6c757d;
                              {% endif %}"
                       data-match="{{ m.ht_id }}"
                       data-match-item
                       data-matchtype="{{ m.matchtype }}">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                      {% if m.home_team_name == teamname %}
                        {% if m.home_goals > m.away_goals %}
                          <span class="badge badge-success badge-sm">W</span>
                        {% elif m.home_goals < m.away_goals %}
                          <span class="badge badge-danger badge-sm">L</span>
                        {% else %}
                          <span class="badge badge-warning badge-sm">D</span>
                        {% endif %}
                      {% else %}
                        {% if m.home_goals > m.away_goals %}
                          <span class="badge badge-danger badge-sm">L</span>
                        {% elif m.home_goals < m.away_goals %}
                          <span class="badge badge-success badge-sm">W</span>
                        {% else %}
                          <span class="badge badge-warning badge-sm">D</span>
                        {% endif %}
                      {% endif %}
                      <small class="text-muted">{{ m.datetime.strftime("%m-%d") }}</small>
                    </div>
                    <div class="fw-bold small d-flex justify-content-between">
                      <span>
                        {% if m.home_team_name == teamname %}
                          {{ m.away_team_name }}
                        {% else %}
                          {{ m.home_team_name }}
                        {% endif %}
                      </span>
                      <span class="text-muted">{{ m.home_goals }}-{{ m.away_goals }}</span>
                    </div>
                  </div>
                {% endif %}
              {% endfor %}
              {% if not history_matches %}<p class="text-muted small">No matches recorded</p>{% endif %}
            </div>
          </div>
        </div>
      </div>
      <!-- Match Details -->
      <div class="col-12 col-lg-8">
        {% for m in upcoming_matches %}
          <!-- Upcoming Match Details for {{ m.ht_id }} -->
          <div class="match-details upcoming-match-details"
               data-match-details="{{ m.ht_id }}"
               style="display: none"
               data-opponent-name="{% if m.home_team_name == teamname %}{{ m.away_team_name }}{% else %}{{ m.home_team_name }}{% endif %}">
            <!-- Match Planning Section -->
            <div class="card mb-4">
              <div class="card-header">
                <h6 class="mb-0">Match Planning: {{ m.home_team_name }} vs {{ m.away_team_name }}</h6>
                <small class="text-muted">{{ m.datetime.strftime("%Y-%m-%d %H:%M") }}</small>
              </div>
              <div class="card-body">
                <div class="alert alert-info mb-3">
                  <h6 class="alert-heading">üîÆ Upcoming Match</h6>
                  <p class="mb-2">
                    This match is scheduled for <strong>{{ m.datetime.strftime("%Y-%m-%d %H:%M") }}</strong>. Plan your tactics and lineup below.
                  </p>
                </div>
                <div class="card border-primary">
                  <div class="card-header bg-primary text-white py-2">
                    <strong class="small">Match Details</strong>
                  </div>
                  <div class="card-body p-2 small">
                    <div class="mb-2">
                      <strong>Match Type:</strong>
                      <span class="text-muted">
                        {% if m.matchtype == 1 %}
                          League
                        {% elif m.matchtype == 3 %}
                          Cup
                        {% elif m.matchtype == 4 %}
                          Friendly
                        {% else %}
                          Unknown
                        {% endif %}
                      </span>
                    </div>
                    <div class="mb-2">
                      <strong>Home Team:</strong> <span class="text-muted">{{ m.home_team_name }}</span>
                      {% if m.home_team_name == teamname %}<span class="badge badge-sm badge-primary ms-2">Your Team</span>{% endif %}
                    </div>
                    <div>
                      <strong>Away Team:</strong> <span class="text-muted">{{ m.away_team_name }}</span>
                      {% if m.away_team_name == teamname %}<span class="badge badge-sm badge-primary ms-2">Your Team</span>{% endif %}
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- Historical Opponent Matches Section -->
            <div class="card">
              <div class="card-header">
                <h6 class="mb-0">
                  Previous Matches vs
                  {% if m.home_team_name == teamname %}
                    {{ m.away_team_name }}
                  {% else %}
                    {{ m.home_team_name }}
                  {% endif %}
                </h6>
              </div>
              <div class="card-body">
                <div id="opponent-history-{{ m.ht_id }}"
                     class="opponent-history-container">
                  <p class="text-muted small text-center py-3">Loading opponent history...</p>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
        {% for m in history_matches %}
          <!-- Match Details for {{ m.ht_id }} -->
          <div class="match-details"
               data-match-details="{{ m.ht_id }}"
               style="display: none">
            <!-- Match Overview -->
            {% if not m.has_enhanced_data() %}
              <div class="row mb-4">
                <div class="col-12">
                  <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                      <h5 class="mb-0">{{ m.home_team_name }} vs {{ m.away_team_name }}</h5>
                      <small class="text-muted">{{ m.datetime.strftime("%Y-%m-%d %H:%M") }}</small>
                    </div>
                    <div class="card-body">
                      <div class="row">
                        <div class="col-md-4 text-center">
                          <h6 class="mb-1">{{ m.home_team_name }}</h6>
                          <div class="mb-2">
                            {% if m.home_team_name == teamname %}<span class="badge badge-primary">Home</span>{% endif %}
                          </div>
                        </div>
                        <div class="col-md-4 text-center">
                          <div class="py-3">
                            {% if m.home_goals is not none and m.away_goals is not none %}
                              <h4 class="mb-0">{{ m.home_goals }} - {{ m.away_goals }}</h4>
                              <small class="text-muted">Final Score</small>
                            {% else %}
                              <h4 class="mb-0">vs</h4>
                              <small class="text-muted">Upcoming</small>
                            {% endif %}
                          </div>
                        </div>
                        <div class="col-md-4 text-center">
                          <h6 class="mb-1">{{ m.away_team_name }}</h6>
                          <div class="mb-2">
                            {% if m.away_team_name == teamname %}<span class="badge badge-primary">Away</span>{% endif %}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            {% endif %}
            <!-- Enhanced Match Statistics -->
            {% if m.home_goals is not none and m.away_goals is not none %}
              <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <h6 class="mb-0">{{ m.home_team_name }} vs {{ m.away_team_name }}</h6>
                  <small class="text-muted">{{ m.datetime.strftime("%Y-%m-%d %H:%M") }}</small>
                </div>
                <div class="card-body">
                  {% if m.has_enhanced_data() %}
                    <!-- Chances & Goals -->
                    {% if m.home_team_total_chances is not none or m.home_goals is not none %}
                      <div class="card mb-3">
                        <div class="card-header py-2">
                          <h6 class="mb-0 small">Chances & Goals</h6>
                        </div>
                        <div class="card-body p-2">
                          <div class="row g-2 mb-2 small text-center">
                            <div class="col-6">
                              <div class="p-2 border rounded"
                                   style="background: {% if teamname == m.home_team_name %}rgba(0, 123, 255, 0.1){% else %}rgba(220, 53, 69, 0.1){% endif %}">
                                <div class="text-muted" style="font-size: 0.75rem;">{{ m.home_team_name }}</div>
                                <div>
                                  <strong style="font-size: 1.5rem;">{{ m.home_goals }}</strong> <span class="text-muted">goals</span>
                                </div>
                                <div class="text-muted" style="font-size: 0.85rem;">
                                  {{ m.home_team_total_chances if m.home_team_total_chances is not none else 'N/A' }} chances
                                </div>
                              </div>
                            </div>
                            <div class="col-6">
                              <div class="p-2 border rounded"
                                   style="background: {% if teamname == m.away_team_name %}rgba(0, 123, 255, 0.1){% else %}rgba(220, 53, 69, 0.1){% endif %}">
                                <div class="text-muted" style="font-size: 0.75rem;">{{ m.away_team_name }}</div>
                                <div>
                                  <strong style="font-size: 1.5rem;">{{ m.away_goals }}</strong> <span class="text-muted">goals</span>
                                </div>
                                <div class="text-muted" style="font-size: 0.85rem;">
                                  {{ m.away_team_total_chances if m.away_team_total_chances is not none else 'N/A' }} chances
                                </div>
                              </div>
                            </div>
                          </div>
                          {% if m.home_team_chances_left is not none %}
                            <div class="row g-2 small">
                              <div class="col-12">
                                <div class="text-muted mb-1" style="font-size: 0.75rem;">Chance Distribution</div>
                              </div>
                              <div class="col-6">
                                <div class="p-1 border rounded">
                                  <div style="font-size: 0.75rem;">
                                    Left: {{ m.home_team_chances_left }} | Center: {{ m.home_team_chances_center }} | Right: {{ m.home_team_chances_right }}
                                  </div>
                                  <div style="font-size: 0.75rem;">
                                    Special: {{ m.home_team_chances_special }} | Other: {{ m.home_team_chances_other }}
                                  </div>
                                </div>
                              </div>
                              <div class="col-6">
                                <div class="p-1 border rounded">
                                  <div style="font-size: 0.75rem;">
                                    Left: {{ m.away_team_chances_left }} | Center: {{ m.away_team_chances_center }} | Right: {{ m.away_team_chances_right }}
                                  </div>
                                  <div style="font-size: 0.75rem;">
                                    Special: {{ m.away_team_chances_special }} | Other: {{ m.away_team_chances_other }}
                                  </div>
                                </div>
                              </div>
                            </div>
                          {% endif %}
                        </div>
                      </div>
                    {% endif %}
                    <!-- Detailed Team Ratings -->
                    {% if m.home_team_rating_right_def is not none %}
                      <div class="card mb-3">
                        <div class="card-header py-2">
                          <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 small">Detailed Ratings</h6>
                            <div class="small text-muted">
                              {% if m.home_team_possession is not none and m.away_team_possession is not none %}
                                <span class="me-3">Possession: {{ m.home_team_possession|round(1) }}% - {{ m.away_team_possession|round(1) }}%</span>
                              {% endif %}
                              {% if m.home_team_rating is not none and m.away_team_rating is not none %}
                                <span>Midfield: {{ m.home_team_rating|round(1) }} - {{ m.away_team_rating|round(1) }}</span>
                              {% endif %}
                            </div>
                          </div>
                        </div>
                        <div class="card-body p-2">
                          <!-- Defense Ratings -->
                          <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                              <strong class="small">Defense</strong>
                            </div>
                            <div class="row g-2 text-center small">
                              <div class="col-4">
                                <div class="p-2 border rounded"
                                     style="{% if m.home_team_rating_right_def is not none and m.away_team_rating_right_def is not none %}{% set home_pct = (m.home_team_rating_right_def / (m.home_team_rating_right_def + m.away_team_rating_right_def) * 100)|round(1) %}background: linear-gradient(to right, {% if teamname == m.home_team_name %}rgba(0, 123, 255, 0.7) 0%, rgba(0, 123, 255, 0.7) {{ home_pct }}%, rgba(220, 53, 69, 0.7) {{ home_pct }}%, rgba(220, 53, 69, 0.7) 100%{% else %}rgba(220, 53, 69, 0.7) 0%, rgba(220, 53, 69, 0.7) {{ home_pct }}%, rgba(0, 123, 255, 0.7) {{ home_pct }}%, rgba(0, 123, 255, 0.7) 100%{% endif %});
                                            color: white;
                                            {% endif %}">
                                  <div class="text-muted"
                                       style="font-size: 0.75rem;
                                              color: rgba(255, 255, 255, 0.9) !important">Right</div>
                                  <div style="position: relative; z-index: 1;">
                                    {{ m.home_team_rating_right_def|round(1) if m.home_team_rating_right_def is not none else 'N/A' }} - {{ m.away_team_rating_right_def|round(1) if m.away_team_rating_right_def is not none else 'N/A' }}
                                  </div>
                                </div>
                              </div>
                              <div class="col-4">
                                <div class="p-2 border rounded"
                                     style="{% if m.home_team_rating_mid_def is not none and m.away_team_rating_mid_def is not none %}{% set home_pct = (m.home_team_rating_mid_def / (m.home_team_rating_mid_def + m.away_team_rating_mid_def) * 100)|round(1) %}background: linear-gradient(to right, {% if teamname == m.home_team_name %}rgba(0, 123, 255, 0.7) 0%, rgba(0, 123, 255, 0.7) {{ home_pct }}%, rgba(220, 53, 69, 0.7) {{ home_pct }}%, rgba(220, 53, 69, 0.7) 100%{% else %}rgba(220, 53, 69, 0.7) 0%, rgba(220, 53, 69, 0.7) {{ home_pct }}%, rgba(0, 123, 255, 0.7) {{ home_pct }}%, rgba(0, 123, 255, 0.7) 100%{% endif %});
                                            color: white;
                                            {% endif %}">
                                  <div class="text-muted"
                                       style="font-size: 0.75rem;
                                              color: rgba(255, 255, 255, 0.9) !important">Center</div>
                                  <div style="position: relative; z-index: 1;">
                                    {{ m.home_team_rating_mid_def|round(1) if m.home_team_rating_mid_def is not none else 'N/A' }} - {{ m.away_team_rating_mid_def|round(1) if m.away_team_rating_mid_def is not none else 'N/A' }}
                                  </div>
                                </div>
                              </div>
                              <div class="col-4">
                                <div class="p-2 border rounded"
                                     style="{% if m.home_team_rating_left_def is not none and m.away_team_rating_left_def is not none %}{% set home_pct = (m.home_team_rating_left_def / (m.home_team_rating_left_def + m.away_team_rating_left_def) * 100)|round(1) %}background: linear-gradient(to right, {% if teamname == m.home_team_name %}rgba(0, 123, 255, 0.7) 0%, rgba(0, 123, 255, 0.7) {{ home_pct }}%, rgba(220, 53, 69, 0.7) {{ home_pct }}%, rgba(220, 53, 69, 0.7) 100%{% else %}rgba(220, 53, 69, 0.7) 0%, rgba(220, 53, 69, 0.7) {{ home_pct }}%, rgba(0, 123, 255, 0.7) {{ home_pct }}%, rgba(0, 123, 255, 0.7) 100%{% endif %});
                                            color: white;
                                            {% endif %}">
                                  <div class="text-muted"
                                       style="font-size: 0.75rem;
                                              color: rgba(255, 255, 255, 0.9) !important">Left</div>
                                  <div style="position: relative; z-index: 1;">
                                    {{ m.home_team_rating_left_def|round(1) if m.home_team_rating_left_def is not none else 'N/A' }} - {{ m.away_team_rating_left_def|round(1) if m.away_team_rating_left_def is not none else 'N/A' }}
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                          <!-- Attack Ratings -->
                          <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                              <strong class="small">Attack</strong>
                            </div>
                            <div class="row g-2 text-center small">
                              <div class="col-4">
                                <div class="p-2 border rounded"
                                     style="{% if m.home_team_rating_right_att is not none and m.away_team_rating_right_att is not none %}{% set home_pct = (m.home_team_rating_right_att / (m.home_team_rating_right_att + m.away_team_rating_right_att) * 100)|round(1) %}background: linear-gradient(to right, {% if teamname == m.home_team_name %}rgba(0, 123, 255, 0.7) 0%, rgba(0, 123, 255, 0.7) {{ home_pct }}%, rgba(220, 53, 69, 0.7) {{ home_pct }}%, rgba(220, 53, 69, 0.7) 100%{% else %}rgba(220, 53, 69, 0.7) 0%, rgba(220, 53, 69, 0.7) {{ home_pct }}%, rgba(0, 123, 255, 0.7) {{ home_pct }}%, rgba(0, 123, 255, 0.7) 100%{% endif %});
                                            color: white;
                                            {% endif %}">
                                  <div class="text-muted"
                                       style="font-size: 0.75rem;
                                              color: rgba(255, 255, 255, 0.9) !important">Right</div>
                                  <div style="position: relative; z-index: 1;">
                                    {{ m.home_team_rating_right_att|round(1) if m.home_team_rating_right_att is not none else 'N/A' }} - {{ m.away_team_rating_right_att|round(1) if m.away_team_rating_right_att is not none else 'N/A' }}
                                  </div>
                                </div>
                              </div>
                              <div class="col-4">
                                <div class="p-2 border rounded"
                                     style="{% if m.home_team_rating_mid_att is not none and m.away_team_rating_mid_att is not none %}{% set home_pct = (m.home_team_rating_mid_att / (m.home_team_rating_mid_att + m.away_team_rating_mid_att) * 100)|round(1) %}background: linear-gradient(to right, {% if teamname == m.home_team_name %}rgba(0, 123, 255, 0.7) 0%, rgba(0, 123, 255, 0.7) {{ home_pct }}%, rgba(220, 53, 69, 0.7) {{ home_pct }}%, rgba(220, 53, 69, 0.7) 100%{% else %}rgba(220, 53, 69, 0.7) 0%, rgba(220, 53, 69, 0.7) {{ home_pct }}%, rgba(0, 123, 255, 0.7) {{ home_pct }}%, rgba(0, 123, 255, 0.7) 100%{% endif %});
                                            color: white;
                                            {% endif %}">
                                  <div class="text-muted"
                                       style="font-size: 0.75rem;
                                              color: rgba(255, 255, 255, 0.9) !important">Center</div>
                                  <div style="position: relative; z-index: 1;">
                                    {{ m.home_team_rating_mid_att|round(1) if m.home_team_rating_mid_att is not none else 'N/A' }} - {{ m.away_team_rating_mid_att|round(1) if m.away_team_rating_mid_att is not none else 'N/A' }}
                                  </div>
                                </div>
                              </div>
                              <div class="col-4">
                                <div class="p-2 border rounded"
                                     style="{% if m.home_team_rating_left_att is not none and m.away_team_rating_left_att is not none %}{% set home_pct = (m.home_team_rating_left_att / (m.home_team_rating_left_att + m.away_team_rating_left_att) * 100)|round(1) %}background: linear-gradient(to right, {% if teamname == m.home_team_name %}rgba(0, 123, 255, 0.7) 0%, rgba(0, 123, 255, 0.7) {{ home_pct }}%, rgba(220, 53, 69, 0.7) {{ home_pct }}%, rgba(220, 53, 69, 0.7) 100%{% else %}rgba(220, 53, 69, 0.7) 0%, rgba(220, 53, 69, 0.7) {{ home_pct }}%, rgba(0, 123, 255, 0.7) {{ home_pct }}%, rgba(0, 123, 255, 0.7) 100%{% endif %});
                                            color: white;
                                            {% endif %}">
                                  <div class="text-muted"
                                       style="font-size: 0.75rem;
                                              color: rgba(255, 255, 255, 0.9) !important">Left</div>
                                  <div style="position: relative; z-index: 1;">
                                    {{ m.home_team_rating_left_att|round(1) if m.home_team_rating_left_att is not none else 'N/A' }} - {{ m.away_team_rating_left_att|round(1) if m.away_team_rating_left_att is not none else 'N/A' }}
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                          <!-- Set Pieces -->
                          <div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                              <strong class="small">Set Pieces</strong>
                            </div>
                            <div class="row g-2 text-center small">
                              <div class="col-6">
                                <div class="p-2 border rounded"
                                     style="{% if m.home_team_rating_set_pieces_def is not none and m.away_team_rating_set_pieces_def is not none %}{% set home_pct = (m.home_team_rating_set_pieces_def / (m.home_team_rating_set_pieces_def + m.away_team_rating_set_pieces_def) * 100)|round(1) %}background: linear-gradient(to right, {% if teamname == m.home_team_name %}rgba(0, 123, 255, 0.7) 0%, rgba(0, 123, 255, 0.7) {{ home_pct }}%, rgba(220, 53, 69, 0.7) {{ home_pct }}%, rgba(220, 53, 69, 0.7) 100%{% else %}rgba(220, 53, 69, 0.7) 0%, rgba(220, 53, 69, 0.7) {{ home_pct }}%, rgba(0, 123, 255, 0.7) {{ home_pct }}%, rgba(0, 123, 255, 0.7) 100%{% endif %});
                                            color: white;
                                            {% endif %}">
                                  <div class="text-muted"
                                       style="font-size: 0.75rem;
                                              color: rgba(255, 255, 255, 0.9) !important">Defense</div>
                                  <div style="position: relative; z-index: 1;">
                                    {{ m.home_team_rating_set_pieces_def|round(1) if m.home_team_rating_set_pieces_def is not none else 'N/A' }} - {{ m.away_team_rating_set_pieces_def|round(1) if m.away_team_rating_set_pieces_def is not none else 'N/A' }}
                                  </div>
                                </div>
                              </div>
                              <div class="col-6">
                                <div class="p-2 border rounded"
                                     style="{% if m.home_team_rating_set_pieces_att is not none and m.away_team_rating_set_pieces_att is not none %}{% set home_pct = (m.home_team_rating_set_pieces_att / (m.home_team_rating_set_pieces_att + m.away_team_rating_set_pieces_att) * 100)|round(1) %}background: linear-gradient(to right, {% if teamname == m.home_team_name %}rgba(0, 123, 255, 0.7) 0%, rgba(0, 123, 255, 0.7) {{ home_pct }}%, rgba(220, 53, 69, 0.7) {{ home_pct }}%, rgba(220, 53, 69, 0.7) 100%{% else %}rgba(220, 53, 69, 0.7) 0%, rgba(220, 53, 69, 0.7) {{ home_pct }}%, rgba(0, 123, 255, 0.7) {{ home_pct }}%, rgba(0, 123, 255, 0.7) 100%{% endif %});
                                            color: white;
                                            {% endif %}">
                                  <div class="text-muted"
                                       style="font-size: 0.75rem;
                                              color: rgba(255, 255, 255, 0.9) !important">Attack</div>
                                  <div style="position: relative; z-index: 1;">
                                    {{ m.home_team_rating_set_pieces_att|round(1) if m.home_team_rating_set_pieces_att is not none else 'N/A' }} - {{ m.away_team_rating_set_pieces_att|round(1) if m.away_team_rating_set_pieces_att is not none else 'N/A' }}
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    {% endif %}
                    <!-- Arena & Match Info -->
                    {% if m.arena_capacity_terraces is not none or m.referee_name or m.attendance is not none %}
                      <div class="card mb-3">
                        <div class="card-header py-2">
                          <h6 class="mb-0 small">Arena & Officials</h6>
                        </div>
                        <div class="card-body p-2">
                          <div class="row g-2 small">
                            {% if m.attendance is not none %}
                              <div class="col-md-6">
                                <strong>Attendance:</strong>
                                <span class="text-muted">{{ "{:,}".format(m.attendance) }}</span>
                              </div>
                            {% endif %}
                            {% if m.arena_capacity_terraces is not none %}
                              <div class="col-md-6">
                                <strong>Arena Capacity:</strong>
                                <div class="text-muted" style="font-size: 0.85rem;">
                                  Terraces: {{ "{:,}".format(m.arena_capacity_terraces) if m.arena_capacity_terraces else 'N/A' }} |
                                  Basic: {{ "{:,}".format(m.arena_capacity_basic) if m.arena_capacity_basic else 'N/A' }}
                                  <br>
                                  Roof: {{ "{:,}".format(m.arena_capacity_roof) if m.arena_capacity_roof else 'N/A' }} |
                                  VIP: {{ "{:,}".format(m.arena_capacity_vip) if m.arena_capacity_vip else 'N/A' }}
                                </div>
                              </div>
                            {% endif %}
                            {% if m.referee_name %}
                              <div class="col-md-6">
                                <strong>Referee:</strong>
                                <div class="text-muted" style="font-size: 0.85rem;">
                                  {{ m.referee_name }}
                                  <br>
                                  {% if m.referee_country %}{{ m.referee_country }}{% endif %}
                                  {% if m.referee_team_name %}
                                    <br>
                                    Team: {{ m.referee_team_name }}
                                  {% endif %}
                                </div>
                              </div>
                            {% endif %}
                            {% if m.weather_id is not none %}
                              <div class="col-md-6">
                                <strong>Weather:</strong>
                                <span class="text-muted">
                                  {% if m.weather_id == 0 %}
                                    ‚òÄÔ∏è Sunny
                                  {% elif m.weather_id == 1 %}
                                    ‚õÖ Partly Cloudy
                                  {% elif m.weather_id == 2 %}
                                    ‚òÅÔ∏è Overcast
                                  {% elif m.weather_id == 3 %}
                                    üåßÔ∏è Rainy
                                  {% else %}
                                    Weather ID {{ m.weather_id }}
                                  {% endif %}
                                </span>
                              </div>
                            {% endif %}
                            {% if m.added_minutes is not none %}
                              <div class="col-md-6">
                                <strong>Added Time:</strong>
                                <span class="text-muted">+{{ m.added_minutes }} minutes</span>
                              </div>
                            {% endif %}
                          </div>
                        </div>
                      </div>
                    {% endif %}
                    <!-- Team Tactics -->
                    {% if m.home_team_formation or m.home_team_tactic_type is not none %}
                      <div class="card mb-3">
                        <div class="card-header py-2">
                          <h6 class="mb-0 small">Formations & Tactics</h6>
                        </div>
                        <div class="card-body p-2">
                          <div class="row g-2 small text-center">
                            <div class="col-6">
                              <div class="p-2 border rounded">
                                <div class="text-muted mb-1" style="font-size: 0.75rem;">{{ m.home_team_name }}</div>
                                <div>
                                  <strong>{{ m.home_team_formation if m.home_team_formation else 'N/A' }}</strong>
                                </div>
                                {% if m.home_team_tactic_type is not none and m.home_team_tactic_type > 0 %}
                                  <div class="text-muted" style="font-size: 0.85rem;">
                                    {% if m.home_team_tactic_type == 1 %}
                                      Pressing
                                    {% elif m.home_team_tactic_type == 2 %}
                                      Counter-Attack
                                    {% elif m.home_team_tactic_type == 3 %}
                                      AIM
                                    {% elif m.home_team_tactic_type == 7 %}
                                      Longshots
                                    {% elif m.home_team_tactic_type == 8 %}
                                      Creative
                                    {% else %}
                                      Tactic {{ m.home_team_tactic_type }}
                                    {% endif %}
                                    ({{ m.home_team_tactic_skill }})
                                  </div>
                                {% endif %}
                              </div>
                            </div>
                            <div class="col-6">
                              <div class="p-2 border rounded">
                                <div class="text-muted mb-1" style="font-size: 0.75rem;">{{ m.away_team_name }}</div>
                                <div>
                                  <strong>{{ m.away_team_formation if m.away_team_formation else 'N/A' }}</strong>
                                </div>
                                {% if m.away_team_tactic_type is not none and m.away_team_tactic_type > 0 %}
                                  <div class="text-muted" style="font-size: 0.85rem;">
                                    {% if m.away_team_tactic_type == 1 %}
                                      Pressing
                                    {% elif m.away_team_tactic_type == 2 %}
                                      Counter-Attack
                                    {% elif m.away_team_tactic_type == 3 %}
                                      AIM
                                    {% elif m.away_team_tactic_type == 7 %}
                                      Longshots
                                    {% elif m.away_team_tactic_type == 8 %}
                                      Creative
                                    {% else %}
                                      Tactic {{ m.away_team_tactic_type }}
                                    {% endif %}
                                    ({{ m.away_team_tactic_skill }})
                                  </div>
                                {% endif %}
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    {% endif %}
                  {% else %}
                    <!-- Limited Data Warning -->
                    <div class="alert alert-warning">
                      <h6 class="alert-heading">‚ö†Ô∏è Limited Match Data</h6>
                      <p class="mb-2">
                        This match only has basic result information. Enhanced data including detailed statistics, formations, and performance metrics is available through the CHPP API.
                      </p>
                      <hr>
                      <p class="mb-0">
                        <strong>To get enhanced match data:</strong> Click "Update Data" to download detailed match information.
                      </p>
                    </div>
                  {% endif %}
                </div>
              </div>
            {% else %}
              <!-- Upcoming Match Info -->
              <div class="card mb-4">
                <div class="card-header">
                  <h6 class="mb-0">Upcoming Match</h6>
                </div>
                <div class="card-body">
                  <div class="alert alert-info">
                    <h6 class="alert-heading">üîÆ Upcoming Match</h6>
                    <p class="mb-2">
                      This match is scheduled for <strong>{{ m.datetime.strftime("%Y-%m-%d %H:%M") }}</strong>. Match statistics and events will be available after the match is played.
                    </p>
                    <hr>
                    <p class="mb-0">
                      <strong>Preparation:</strong> Use the Formation Tester to plan your tactics for this match, and check opponent history in your league standings.
                    </p>
                  </div>
                </div>
              </div>
            {% endif %}
          </div>
        {% endfor %}
        <!-- No match selected message -->
        <div class="col-12" id="noMatchSelected" data-no-match>
          <div class="card">
            <div class="card-body text-center">
              <h5 class="text-muted">Select a match to view details</h5>
              <p class="text-muted">Click on any match from the history to see detailed information, lineup, and statistics.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
document.addEventListener('DOMContentLoaded', function() {
    // Match filter functionality
    const filterButtons = document.querySelectorAll('.filter-btn');
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            const filter = this.getAttribute('data-filter');
            const target = this.getAttribute('data-target');

            // Remove active class from siblings
            const siblings = this.parentNode.querySelectorAll('.filter-btn');
            siblings.forEach(sibling => sibling.classList.remove('active'));

            // Add active class to clicked button
            this.classList.add('active');

            // Filter matches based on target (upcoming or history)
            if (target === 'history') {
                const matchItems = document.querySelectorAll('[data-match-item]');
                matchItems.forEach(item => {
                    const matchType = item.getAttribute('data-matchtype');
                    if (filter === 'all' || matchType === filter) {
                        item.style.display = '';
                    } else {
                        item.style.display = 'none';
                    }
                });
            }
        });
    });

    // Match selection functionality
    const matchItems = document.querySelectorAll('[data-match]');
    const noMatchSelected = document.getElementById('noMatchSelected');

    matchItems.forEach(item => {
        item.addEventListener('click', function() {
            const matchId = this.getAttribute('data-match');

            // Remove active class from all matches
            matchItems.forEach(m => m.classList.remove('active'));
            // Add active class to selected match
            this.classList.add('active');

            // Hide all match details
            document.querySelectorAll('.match-details').forEach(detail => {
                detail.style.display = 'none';
            });

            // Hide no match selected message
            if (noMatchSelected) noMatchSelected.style.display = 'none';

            // Show selected match details
            const selectedMatchDetails = document.querySelector(`[data-match-details="${matchId}"]`);
            if (selectedMatchDetails) {
                selectedMatchDetails.style.display = 'block';

                // If this is an upcoming match, populate opponent history
                if (selectedMatchDetails.classList.contains('upcoming-match-details')) {
                    const opponentName = selectedMatchDetails.getAttribute('data-opponent-name');
                    const historyContainer = selectedMatchDetails.querySelector('.opponent-history-container');

                    if (historyContainer && opponentName) {
                        // Filter history matches against this opponent - only search in the Recent Matches sidebar
                        const recentMatchesContainer = document.querySelector('.card-body[style*="max-height: 600px"]');
                        const allHistoryMatches = recentMatchesContainer ? recentMatchesContainer.querySelectorAll('[data-match-item]') : [];
                        let opponentMatches = [];

                        allHistoryMatches.forEach(histMatch => {
                            const matchEl = histMatch;
                            const opponentSpan = matchEl.querySelector('.fw-bold span');
                            if (opponentSpan) {
                                const opponentText = opponentSpan.textContent.trim();
                                if (opponentText === opponentName) {
                                    opponentMatches.push(histMatch);
                                }
                            }
                        });

                        if (opponentMatches.length > 0) {
                            let html = '<div class="list-group list-group-flush">';
                            opponentMatches.forEach(match => {
                                const clonedMatch = match.cloneNode(true);
                                clonedMatch.classList.remove('list-group-item-action');
                                clonedMatch.style.cursor = 'default';
                                clonedMatch.removeAttribute('data-match');
                                clonedMatch.removeAttribute('data-match-item');
                                html += clonedMatch.outerHTML;
                            });
                            html += '</div>';
                            historyContainer.innerHTML = html;
                        } else {
                            historyContainer.innerHTML = '<p class="text-muted small text-center py-3">No previous matches found against this opponent.</p>';
                        }
                    }
                }
            }
        });
    });

});
  </script>
{% endblock %}
